<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>EVYON IA - Acceso Institucional</title>

    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef1f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100dvh; 
            margin: 0;
            overflow: hidden; 
            overscroll-behavior: none;
        }

        /* --- CONTENEDOR PRINCIPAL (LA CAJA) --- */
        .app-card {
            width: 90%;
            max-width: 420px;
            background-color: #3D3D3D;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0px 15px 35px rgba(0, 0, 0, 0.4);
            position: relative;
            display: flex;
            flex-direction: column;
            height: 90vh; 
            max-height: 800px;
            transition: all 0.3s ease;
        }

        /* MODO APP EN MÃ“VIL (PANTALLA COMPLETA) */
        @media (max-width: 600px) {
            .app-card {
                width: 100%;
                height: 100dvh;
                max-width: none;
                max-height: none;
                border-radius: 0;
                padding: 15px;
                box-shadow: none;
            }
            body { background-color: #2b2b2b; }
        }

        /* --- PANTALLA DE LOGIN --- */
        #login-screen {
            text-align: center;
            color: white;
            justify-content: center;
        }

        .login-logo {
            font-size: 28px; font-weight: 800; margin-bottom: 5px; color: #3cd186; letter-spacing: 1px;
        }
        .login-subtitle {
            font-size: 13px; color: #aaa; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 1px;
        }
        .login-input {
            width: 100%; padding: 14px; margin: 8px 0;
            border: 1px solid #555; border-radius: 8px;
            background-color: #2b2b2b; color: white;
            outline: none; box-sizing: border-box; transition: all 0.3s;
            font-size: 16px; /* Anti-zoom iOS */
        }
        .login-input:focus { border-color: #3cd186; background-color: #333; }
        .login-btn {
            width: 100%; padding: 14px; margin-top: 20px;
            background: linear-gradient(90deg, #3cd186, #2eb06d);
            color: white; border: none; border-radius: 8px;
            font-weight: bold; font-size: 16px; cursor: pointer;
            transition: transform 0.2s;
        }
        .login-btn:hover { transform: translateY(-2px); }
        .error-msg { color: #ff6b6b; font-size: 13px; margin-top: 15px; opacity: 0; transition: opacity 0.3s; }

        /* --- INTERFAZ DE CHAT --- */
        #chat-interface {
            display: none; opacity: 0;
            /* Flex column es vital para que no se desparrame */
            flex-direction: column; 
            height: 100%;
        }

        .chat-header {
            background-color: #2b2b2b; color: white;
            padding: 15px; border-radius: 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            flex-shrink: 0; 
        }

        .header-actions { display: flex; gap: 10px; }
        .header-btn { font-size: 12px; color: #aaa; cursor: pointer; background: none; border: none; text-decoration: underline; }
        .header-btn:hover { color: white; }
        .btn-clear:hover { color: #ff6b6b; }

        /* --- CHAT BOX --- */
        .chat-box {
            background-color: #ffffff;
            flex: 1; 
            overflow-y: auto;
            padding: 15px; border-radius: 12px;
            display: flex; flex-direction: column; gap: 15px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; 
        }

        .message-row { display: flex; align-items: flex-end; gap: 8px; max-width: 100%; }
        .message-row.user { justify-content: flex-end; }
        .message-row.bot { justify-content: flex-start; }

        .avatar {
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-size: 18px; flex-shrink: 0;
        }
        .bot-avatar { background-color: #e0f2f1; border: 1px solid #3cd186; }
        .user-avatar { background-color: #3cd186; color: white; }

        .message-bubble {
            padding: 12px 16px; border-radius: 14px; max-width: 80%;
            font-size: 15px; line-height: 1.5; word-wrap: break-word; position: relative;
        }
        .user .message-bubble { background-color: #3cd186; color: white; border-bottom-right-radius: 2px; box-shadow: 0 2px 5px rgba(60, 209, 134, 0.2); }
        .bot .message-bubble { background-color: #f3f4f6; color: #333; border-bottom-left-radius: 2px; border: 1px solid #eee; }
        .chat-title { font-weight: 800; color: #1b5e20; margin-top: 10px; display: block; }
        strong { font-weight: 700; }

        /* --- SUGGESTIONS --- */
        .suggestions-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .suggestion-chip {
            background-color: white; border: 1px solid #3cd186; color: #3cd186;
            padding: 6px 12px; border-radius: 20px; font-size: 13px;
            cursor: pointer; font-weight: 600; transition: all 0.2s;
        }
        .suggestion-chip:hover { background-color: #3cd186; color: white; }

        /* --- INPUT AREA --- */
        .input-wrapper {
            margin-top: 10px; background-color: #2b2b2b; padding: 10px; border-radius: 12px; flex-shrink: 0;
        }
        .input-container { display: flex; gap: 8px; align-items: flex-end; }
        .chat-input {
            flex: 1; padding: 10px; border: none; border-radius: 8px;
            outline: none; resize: none; background: white;
            font-family: inherit; min-height: 24px; max-height: 100px;
            overflow-y: hidden; font-size: 16px; 
        }
        .send-btn {
            background-color: #3cd186; color: white; border: none;
            padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; height: 44px;
        }
        .send-btn:hover { background-color: #2eb06d; }
        .disclaimer { font-size: 10px; color: #888; text-align: center; margin-top: 8px; }

    </style>
</head>

<body>

    <div class="app-card" id="login-screen">
        <div class="login-logo">EVYON IA ðŸ”’</div>
        <div class="login-subtitle">Acceso Institucional Seguro</div>

        <input type="text" id="username" class="login-input" placeholder="Usuario / ID" onkeydown="handleLoginKey(event)">
        <input type="password" id="password" class="login-input" placeholder="ContraseÃ±a" onkeydown="handleLoginKey(event)">
        
        <div id="loginError" class="error-msg">Credenciales incorrectas</div>
        <button class="login-btn" onclick="attemptLogin()">INGRESAR</button>
    </div>

    <div class="app-card" id="chat-interface">
        
        <div class="chat-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <img src="logo.jpeg" alt="Logo" style="height: 40px; width: 40px; border-radius: 50%; object-fit: cover;">
                <span style="font-weight:bold; font-size:18px;">EVYON IA</span>
            </div>
            <div class="header-actions">
                <button class="header-btn btn-clear" onclick="clearChat()">Limpiar Chat</button>
                <button class="header-btn" onclick="logout()">Salir</button>
            </div>
        </div>

        <div class="chat-box" id="chatBox"></div>

        <div class="input-wrapper">
            <div class="input-container">
                <textarea id="userInput" class="chat-input" placeholder="Escribe aquÃ­..." rows="1" oninput="autoResize(this)" onkeydown="handleChatKey(event)"></textarea>
                <button class="send-btn" onclick="sendMessage()">âž¤</button>
            </div>
            <div class="disclaimer">EVYON es un asistente IA. No sustituye consejo mÃ©dico profesional.</div>
        </div>
    </div>

    <script>
        /* --------------------------
           CONFIGURACIÃ“N Y DATOS
        ---------------------------*/
        let apiKey = localStorage.getItem("evyon_api_key");
        let currentUserData = null;
        let conversationHistory = []; 

        const INSTITUTION_DB = {
            "tec": { 
                pass: "TEC2106",
                name: "A01825448_IvÃ¡n Emiliano LÃ³pez Vargas",
                welcome: "Â¡Hola Borrego! ðŸ Soy EVYON, tu experto integral.\n\nÂ¿Por dÃ³nde empezamos hoy?",
                suggestions: ["ðŸ›Œ Optimizar sueÃ±o", "ðŸ¥¦ Plan nutricional", "ðŸ‹ï¸â€â™‚ï¸ Ajustar rutina"]
            },
            "justin": { 
                pass: "TEC2025", 
                name: "Justin (El DiscÃ­pulo)", 
                welcome: "Â¡QuÃ© onda Borrego! ðŸ Bienvenido al nivel del 'Sensei' IvÃ¡n.\n\nNo te limites a las pesas. Â¿En quÃ© te ayudo hoy?",
                suggestions: ["ðŸ”¥ Romper estancamiento", "ðŸ§  SuplementaciÃ³n", "ðŸ”‹ EnergÃ­a para estudiar"]
            },
            "gatito": { 
                pass: "Pachon123", 
                name: "Mi NiÃ±a â¤ï¸", 
                welcome: "Â¡Hola hermosa! â¤ï¸ Bienvenida a tu espacio personal en EVYON.\n\nEstoy programado para cuidarte y ayudarte a ponerte mÃ¡s guapa y fuerte. Â¿QuÃ© se te antoja hacer hoy?",
                suggestions: ["ðŸ‘ Rutina de GlÃºteo", "ðŸ« Snacks saludables", "ðŸ§˜â€â™€ï¸ Yoga para el estrÃ©s"]
            },
            "oxigeno": {
                pass: "oxi123", name: "Gimnasio OxÃ­geno",
                welcome: "Â¡Hola equipo OxÃ­geno! ðŸ’ª Listos para optimizar.",
                suggestions: ["Rutina Hipertrofia", "DÃ©ficit CalÃ³rico"]
            },
            "a01825448": {
                pass: "TEC2106", name: "IvÃ¡n Emiliano LÃ³pez Vargas",
                welcome: "Â¡Hola Borrego! Â¿CÃ³mo puedo apoyarte hoy?",
                suggestions: ["AnÃ¡lisis de rendimiento", "Dieta Anti-inflamatoria"]
            }
        };

        /* --------------------------
           LOGIN & INICIO
        ---------------------------*/
        function attemptLogin() {
            const userKey = document.getElementById("username").value.trim(); 
            const dbKey = Object.keys(INSTITUTION_DB).find(key => key.toLowerCase() === userKey.toLowerCase());
            const passInput = document.getElementById("password").value.trim();
            const errorMsg = document.getElementById("loginError");

            if (dbKey && INSTITUTION_DB[dbKey].pass === passInput) {
                currentUserData = INSTITUTION_DB[dbKey];
                localStorage.setItem("evyon_current_user", dbKey); 
                errorMsg.style.opacity = "0";
                transitionToChat();
            } else {
                errorMsg.innerText = "Usuario o contraseÃ±a incorrectos.";
                errorMsg.style.opacity = "1";
                shakeModal();
            }
        }

        window.onload = function() {
            const savedUser = localStorage.getItem("evyon_current_user");
            if (savedUser && INSTITUTION_DB[savedUser]) {
                currentUserData = INSTITUTION_DB[savedUser];
                transitionToChat();
            }
        };

        function transitionToChat() {
            document.getElementById("login-screen").style.display = "none";
            const chat = document.getElementById("chat-interface");
            chat.style.display = "flex";
            setTimeout(() => { chat.style.opacity = "1"; }, 50);
            loadChatHistory();
        }

        function logout() { 
            localStorage.removeItem("evyon_current_user");
            location.reload(); 
        }

        function clearChat() {
            if(confirm("Â¿Borrar toda la conversaciÃ³n?")) {
                localStorage.removeItem(`evyon_chat_${currentUserData.name}`);
                conversationHistory = [];
                document.getElementById("chatBox").innerHTML = "";
                appendMessage("EVYON IA", currentUserData.welcome, "bot", false);
                renderSuggestions(currentUserData.suggestions);
            }
        }

        function shakeModal() {
            const box = document.getElementById("login-screen");
            box.style.transform = "translateX(10px)";
            setTimeout(() => box.style.transform = "translateX(-10px)", 100);
            setTimeout(() => box.style.transform = "translateX(0)", 200);
        }

        function handleLoginKey(e) { if (e.key === "Enter") attemptLogin(); }

        async function checkApiKey() {
            if (!apiKey) {
                apiKey = prompt("ðŸ”’ INGRESA TU API KEY:\n(Se guardarÃ¡ segura en tu navegador)");
                if (apiKey) {
                    localStorage.setItem("evyon_api_key", apiKey);
                } else {
                    alert("Se requiere API Key.");
                    return false;
                }
            }
            return true;
        }

        /* --------------------------
           CEREBRO (PROMPT)
        ---------------------------*/
        function getDynamicSystemPrompt(text, user) {
            const lowerText = text.toLowerCase();
            if (lowerText.includes("dolor") || lowerText.includes("duele") || lowerText.includes("lesiÃ³n")) {
                return `Fisioterapeuta Deportivo Cauteloso para ${user.name}. Seguridad ante todo. Si hay dolor, sugiere descanso/mÃ©dico.`;
            }
            if (lowerText.includes("flojera") || lowerText.includes("no quiero")) {
                return `Coach Espartano para ${user.name}. Motiva con energÃ­a y brevedad.`;
            }
            return `Eres EVYON, Experto en Rendimiento Humano (NutriciÃ³n, Entreno, SueÃ±o) para: ${user.name}.
            REGLAS:
            1. NO saludes con "Hola ${user.name}" siempre.
            2. PERFILA: Si no tienes datos, pregÃºntalos.
            3. ESPEJO: AdÃ¡ptate al tono (tÃ©cnico vs emocional).
            4. RECHAZO: Si preguntan de Autos/TecnologÃ­a, di: "No soy experto en eso, pero si tu cuerpo fuera un auto...".
            5. FORMATO: Listas y negritas.`;
        }

        /* --------------------------
           LÃ“GICA DEL CHAT
        ---------------------------*/
        async function sendMessage(manualText = null) {
            if (!await checkApiKey()) return;

            let input = document.getElementById("userInput");
            let text = manualText || input.value.trim();
            if (!text) return;

            appendMessage("TÃº", text, "user", false);
            saveToHistory("user", text);
            input.value = "";
            input.style.height = "auto";
            
            const oldSuggestions = document.querySelector('.suggestions-container');
            if(oldSuggestions) oldSuggestions.remove();

            const loadingId = showLoadingIndicator();

            const systemPrompt = getDynamicSystemPrompt(text, currentUserData);
            let apiMessages = [{ role: "system", content: systemPrompt }, ...conversationHistory];

            try {
                let res = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: apiMessages,
                        max_tokens: 1000, 
                        temperature: 0.7
                    })
                });

                let data = await res.json();
                removeLoadingIndicator(loadingId);

                if (data.error) {
                    if (data.error.code === 'invalid_api_key') {
                        localStorage.removeItem("evyon_api_key"); apiKey = null;
                        appendMessage("SISTEMA", "API Key invÃ¡lida.", "bot", false);
                    } else { throw new Error(data.error.message); }
                } else {
                    let botText = data.choices[0].message.content;
                    appendMessage("EVYON IA", botText, "bot", true);
                    saveToHistory("assistant", botText);
                }
            } catch (err) {
                removeLoadingIndicator(loadingId);
                appendMessage("EVYON IA", "âš ï¸ Error de conexiÃ³n.", "bot", false);
            }
        }

        function saveToHistory(role, content) {
            conversationHistory.push({ role, content });
            if (conversationHistory.length > 15) conversationHistory = conversationHistory.slice(conversationHistory.length - 15);
            localStorage.setItem(`evyon_chat_${currentUserData.name}`, JSON.stringify(conversationHistory));
        }

        function loadChatHistory() {
            const saved = localStorage.getItem(`evyon_chat_${currentUserData.name}`);
            const box = document.getElementById("chatBox");
            box.innerHTML = ""; 
            if (saved) {
                conversationHistory = JSON.parse(saved);
                conversationHistory.forEach(msg => {
                    const sender = msg.role === 'user' ? "TÃº" : "EVYON IA";
                    const cssClass = msg.role === 'user' ? "user" : "bot";
                    appendMessage(sender, msg.content, cssClass, false);
                });
            } else {
                appendMessage("EVYON IA", currentUserData.welcome, "bot", false);
                renderSuggestions(currentUserData.suggestions);
            }
        }

        /* --------------------------
           VISUALES & UTILS
        ---------------------------*/
        function formatText(text) {
            let formatted = text.replace(/^\s*---\s*$/gm, '');
            formatted = formatted.replace(/^\s*#{1,6}\s+(.*$)/gm, '<div class="chat-title">$1</div>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/^- (.*)/gm, 'â€¢ $1');
            return formatted;
        }

        function renderSuggestions(list) {
            let box = document.getElementById("chatBox");
            let container = document.createElement("div");
            container.className = "suggestions-container";
            list.forEach(item => {
                let btn = document.createElement("div");
                btn.className = "suggestion-chip";
                btn.innerText = item;
                btn.onclick = () => sendMessage(item);
                container.appendChild(btn);
            });
            box.appendChild(container);
            box.scrollTop = box.scrollHeight;
        }

        function appendMessage(sender, message, type, useTyping) {
            let box = document.getElementById("chatBox");
            let row = document.createElement("div");
            row.className = `message-row ${type}`;

            let avatar = document.createElement("div");
            avatar.className = `avatar ${type}-avatar`;
            avatar.innerHTML = type === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';

            let bubble = document.createElement("div");
            bubble.className = "message-bubble";
            let formattedHtml = formatText(message);
            bubble.innerHTML = formattedHtml;

            if (type === 'bot') { row.appendChild(avatar); row.appendChild(bubble); } 
            else { row.appendChild(bubble); }

            box.appendChild(row);
            box.scrollTop = box.scrollHeight;
        }

        function showLoadingIndicator() {
            const id = "loading-" + Date.now();
            let box = document.getElementById("chatBox");
            let row = document.createElement("div");
            row.className = "message-row bot";
            row.id = id;
            row.innerHTML = `<div class="avatar bot-avatar">ðŸ¤–</div><div class="message-bubble" style="color:#888; font-style:italic;">Escribiendo...</div>`;
            box.appendChild(row);
            box.scrollTop = box.scrollHeight;
            return id;
        }

        function removeLoadingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function handleChatKey(e) {
            if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        }
    </script>
</body>
</html>
