<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVYON IA - Acceso Institucional</title>

    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        /* --- CONTENEDORES --- */
        .app-card {
            width: 350px;
            background-color: #3D3D3D;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0px 10px 25px rgba(0, 0, 0, 0.3);
            position: relative;
            transition: opacity 0.5s ease;
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            text-align: center;
            color: white;
            padding: 20px 10px;
        }

        .login-logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #3cd186;
        }

        .login-input {
            width: 90%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #555;
            border-radius: 6px;
            background-color: #2b2b2b;
            color: white;
            outline: none;
            transition: border 0.3s;
        }

        .login-input:focus {
            border-color: #3cd186;
        }

        .login-btn {
            width: 98%;
            padding: 12px;
            margin-top: 15px;
            background-color: #3cd186;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-btn:hover {
            background-color: #2eb06d;
        }

        .error-msg {
            color: #ff6b6b;
            font-size: 13px;
            margin-top: 10px;
            min-height: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* --- CHAT --- */
        #chat-interface {
            display: none;
            opacity: 0;
        }

        .chat-header {
            background-color: #333;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logout-btn {
            font-size: 12px;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
        }
        .logout-btn:hover {
            color: white;
        }

        .chat-box {
            background-color: white;
            height: 350px;
            overflow-y: auto;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }

        .user-message, .bot-message {
            padding: 10px 14px;
            border-radius: 12px;
            margin: 6px 0;
            max-width: 80%;
            font-size: 14px;
            line-height: 1.4;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .user-message {
            background-color: #3cd186;
            color: white;
            align-self: flex-end;
            text-align: right;
            border-bottom-right-radius: 2px;
        }

        .bot-message {
            background-color: #f1f1f1;
            color: #333;
            align-self: flex-start;
            text-align: left;
            border-bottom-left-radius: 2px;
        }

        .input-container {
            display: flex;
            margin-top: 15px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            outline: none;
            resize: none;
            height: 45px;
        }

        .send-btn {
            background-color: #3cd186;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 8px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <!-- LOGIN -->
    <div class="app-card" id="login-screen">
        <div class="login-logo">EVYON IA üîí</div>
        <p style="font-size: 14px; color: #ccc; margin-bottom: 20px;">Acceso Institucional</p>

        <input type="text" id="username" class="login-input" placeholder="Usuario / ID Instituci√≥n" onkeydown="handleLoginKey(event)">
        <input type="password" id="password" class="login-input" placeholder="Contrase√±a" onkeydown="handleLoginKey(event)">
        
        <div id="loginError" class="error-msg">Credenciales incorrectas</div>
        <button class="login-btn" onclick="attemptLogin()">INGRESAR</button>
    </div>

    <!-- CHAT -->
    <div class="app-card" id="chat-interface">
        <div class="chat-header">
            <span>EVYON IA ü§ñ</span>
            <button class="logout-btn" onclick="logout()">Salir</button>
        </div>

        <div class="chat-box" id="chatBox"></div>

        <div class="input-container">
            <textarea id="userInput" class="chat-input" placeholder="Escribe tu mensaje..." onkeydown="handleChatKey(event)"></textarea>
            <button class="send-btn" onclick="sendMessage()">Enviar</button>
        </div>
    </div>

    <script>
        /* --------------------------
           CONFIGURACI√ìN Y BASE DE DATOS
        ---------------------------*/
        let apiKey = localStorage.getItem("evyon_api_key");
        let currentUserData = null; // Ahora guardaremos toda la info del usuario

        // üëá AQU√ç EDITAS TUS USUARIOS Y MENSAJES üëá
        const INSTITUTION_DB = {
            "admin": {
                pass: "evyon2025",
                name: "ADMINISTRADOR",
                welcome: "Modo Dios activado. ¬øQu√© vamos a construir hoy?"
            },
            "oxigeno": {
                pass: "oxi123",
                name: "Gimnasio Ox√≠geno",
                welcome: "¬°Hola equipo Ox√≠geno! Listos para optimizar la nutrici√≥n de sus atletas."
            },
            "goldgym": {
                pass: "gold99",
                name: "Gold's Gym Norte",
                welcome: "Bienvenido. Recuerda: No pain, no gain. ¬øEn qu√© ayudamos a tus socios hoy?"
            },
            "cruzazul": {
                pass: "azul2025",
                name: "Club Deportivo Cruz Azul",
                welcome: "Saludos al equipo m√©dico. EVYON est√° listo para asistir en el rendimiento."
            }
        };

        /* --------------------------
           L√ìGICA DE LOGIN MEJORADA
        ---------------------------*/
        function attemptLogin() {
            // Convertimos a min√∫sculas para que no importe si escriben "Admin" o "admin"
            const userKey = document.getElementById("username").value.trim().toLowerCase();
            const passInput = document.getElementById("password").value.trim();
            const errorMsg = document.getElementById("loginError");

            // Verificamos si el usuario existe Y si la contrase√±a coincide
            if (INSTITUTION_DB[userKey] && INSTITUTION_DB[userKey].pass === passInput) {
                currentUserData = INSTITUTION_DB[userKey]; // Guardamos qui√©n entr√≥
                errorMsg.style.opacity = "0";
                transitionToChat();
            } else {
                errorMsg.innerText = "Usuario o contrase√±a incorrectos.";
                errorMsg.style.opacity = "1";
                shakeModal();
            }
        }

        function transitionToChat() {
            document.getElementById("login-screen").style.display = "none";
            const chat = document.getElementById("chat-interface");
            chat.style.display = "block";

            setTimeout(() => { chat.style.opacity = "1"; }, 50);

            // üëá AQU√ç USAMOS EL MENSAJE PERSONALIZADO üëá
            if(document.getElementById("chatBox").children.length === 0){
                 appendMessage(
                    "EVYON IA",
                    `<b>${currentUserData.welcome}</b><br><br>Soy tu asistente virtual.`, 
                    "bot-message"
                );
            }

            setTimeout(() => document.getElementById("userInput").focus(), 300);
        }

        /* --------------------------
           RESTO DEL C√ìDIGO (Igual que antes)
        ---------------------------*/
        function logout() { location.reload(); }

        function shakeModal() {
            const box = document.getElementById("login-screen");
            box.style.transform = "translateX(10px)";
            setTimeout(() => box.style.transform = "translateX(-10px)", 100);
            setTimeout(() => box.style.transform = "translateX(0)", 200);
        }

        function handleLoginKey(e) { if (e.key === "Enter") attemptLogin(); }

        async function checkApiKey() {
            if (!apiKey) {
                apiKey = prompt("üîí INGRESA TU API KEY:\n(Se guardar√° segura en tu navegador)");
                if (apiKey) {
                    localStorage.setItem("evyon_api_key", apiKey);
                } else {
                    alert("Se requiere API Key.");
                    return false;
                }
            }
            return true;
        }

        async function sendMessage() {
            if (!await checkApiKey()) return;

            let input = document.getElementById("userInput");
            let text = input.value.trim();
            if (!text) return;

            appendMessage("T√∫", text, "user-message");
            input.value = "";
            const loadingId = showLoadingIndicator();

            try {
                let res = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            {
                                role: "system",
                                // Personalizamos tambi√©n c√≥mo se comporta la IA seg√∫n la instituci√≥n
                                content: `Eres un experto en deporte asesorando a: ${currentUserData.name}. Responde en espa√±ol, s√© breve y profesional.`
                            },
                            { role: "user", content: text }
                        ],
                        max_tokens: 150
                    })
                });

                let data = await res.json();
                removeLoadingIndicator(loadingId);

                if (data.error) {
                    if (data.error.code === 'invalid_api_key' || data.error.code === 'invalid_api_key_header') {
                        localStorage.removeItem("evyon_api_key");
                        apiKey = null;
                        appendMessage("SISTEMA", "‚ùå API Key inv√°lida.", "bot-message");
                    } else { throw new Error(data.error.message); }
                } else {
                    appendMessage("EVYON IA", data.choices[0].message.content, "bot-message");
                }
            } catch (err) {
                removeLoadingIndicator(loadingId);
                appendMessage("EVYON IA", "‚ö†Ô∏è Error de conexi√≥n.", "bot-message");
            }
        }

        function appendMessage(sender, message, className) {
            let box = document.getElementById("chatBox");
            let div = document.createElement("div");
            div.classList.add(className);
            div.innerHTML = `<strong>${sender}:</strong> ${message}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function showLoadingIndicator() {
            const id = "loading-" + Date.now();
            let box = document.getElementById("chatBox");
            let div = document.createElement("div");
            div.id = id;
            div.classList.add("bot-message");
            div.style.fontStyle = "italic";
            div.style.color = "#888";
            div.innerHTML = "Analizando...";
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            return id;
        }

        function removeLoadingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function handleChatKey(e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
    </script>
</body>
</html>
