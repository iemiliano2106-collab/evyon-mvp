<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>EVYON IA - Acceso Institucional</title>

    <style>
        /* --- FUENTES & RESET --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            font-family: 'Inter', sans-serif;
            height: 100%; width: 100%;
            margin: 0; padding: 0;
            overflow: hidden;
            position: fixed; top: 0; left: 0;
            /* Fondo Moderno Animado */
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #000000 100%);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #ffffff;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body { display: flex; justify-content: center; align-items: center; }

        /* --- CONTENEDOR PRINCIPAL (GLASSMORPHISM) --- */
        .app-card {
            width: 95%; max-width: 450px;
            height: 90vh; max-height: 850px;
            /* Efecto Vidrio Tecnol√≥gico */
            background: rgba(20, 20, 20, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 20px rgba(60, 209, 134, 0.05); /* Glow sutil */
            
            display: flex; flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* MODO M√ìVIL OPTIMIZADO */
        @media (max-width: 600px) {
            .app-card {
                width: 100%; height: 100%;
                border-radius: 0; border: none;
                background: rgba(15, 15, 15, 0.85); /* Un poco m√°s oscuro en m√≥vil */
            }
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 40px; text-align: center;
            height: 100%;
        }

        .login-logo {
            font-size: 32px; font-weight: 800;
            background: linear-gradient(to right, #3cd186, #ffffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px; letter-spacing: -1px;
        }

        .login-subtitle { font-size: 12px; color: #8899a6; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 40px; }

        .login-input {
            width: 100%; padding: 16px; margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; color: white;
            font-size: 16px; outline: none;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: #3cd186;
            box-shadow: 0 0 15px rgba(60, 209, 134, 0.2);
        }

        .login-btn {
            width: 100%; padding: 16px; margin-top: 25px;
            background: linear-gradient(90deg, #3cd186, #22c55e);
            color: #000; border: none; border-radius: 12px;
            font-weight: 800; font-size: 16px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(60, 209, 134, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(60, 209, 134, 0.4); }
        .error-msg { color: #ff6b6b; font-size: 13px; margin-top: 20px; min-height: 20px; transition: opacity 0.3s; opacity: 0; }

        /* --- INTERFAZ CHAT --- */
        #chat-interface {
            display: none; flex-direction: column; height: 100%; opacity: 0; transition: opacity 0.5s ease;
        }

        /* Header Minimalista Flotante */
        .chat-header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 10;
        }

        .header-actions { display: flex; gap: 15px; }
        .header-btn {
            background: none; border: none; color: #8899a6;
            font-size: 12px; font-weight: 600; cursor: pointer;
            transition: color 0.2s;
        }
        .header-btn:hover { color: #fff; text-decoration: none; }
        .btn-clear:hover { color: #ff6b6b; }

        /* Chat Area */
        .chat-box {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 18px;
            scroll-behavior: smooth;
        }

        /* Scrollbar Personalizado (Sleek) */
        .chat-box::-webkit-scrollbar { width: 6px; }
        .chat-box::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        .chat-box::-webkit-scrollbar-track { background: transparent; }

        /* Mensajes */
        .message-row { 
            display: flex; align-items: flex-end; gap: 10px; max-width: 100%; 
            animation: slideIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .message-row.user { justify-content: flex-end; }
        
        .avatar {
            width: 32px; height: 32px; border-radius: 10px;
            display: flex; justify-content: center; align-items: center;
            font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .bot-avatar { background: #1e293b; color: #3cd186; border: 1px solid rgba(60, 209, 134, 0.3); }
        .user-avatar { background: #3cd186; color: #000; }

        .message-bubble {
            padding: 14px 18px; border-radius: 18px; max-width: 85%;
            font-size: 15px; line-height: 1.5; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Burbujas Estilizadas */
        .bot .message-bubble {
            background: rgba(255, 255, 255, 0.08); /* Gris oscuro transl√∫cido */
            color: #e2e8f0;
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .user .message-bubble {
            background: linear-gradient(135deg, #3cd186, #22c55e); /* Gradiente Verde EVYON */
            color: #0f172a; font-weight: 500;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 15px rgba(60, 209, 134, 0.2);
        }

        .chat-title { font-weight: 800; color: #3cd186; margin-top: 15px; margin-bottom: 5px; font-size: 1.1em; letter-spacing: -0.5px; }
        strong { color: #fff; font-weight: 700; }
        .user strong { color: #000; } /* Strong en burbuja usuario */

        /* Sugerencias (Chips) */
        .suggestions-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .suggestion-chip {
            background: rgba(60, 209, 134, 0.1);
            border: 1px solid rgba(60, 209, 134, 0.3);
            color: #3cd186; padding: 8px 16px;
            border-radius: 20px; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .suggestion-chip:hover { background: #3cd186; color: #000; transform: translateY(-2px); }

        /* Input Area Flotante */
        .input-wrapper {
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .input-container {
            display: flex; gap: 10px; align-items: flex-end;
            background: rgba(255, 255, 255, 0.08);
            padding: 8px; border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: border-color 0.3s;
        }
        .input-container:focus-within { border-color: rgba(60, 209, 134, 0.5); }

        .chat-input {
            flex: 1; background: transparent; border: none;
            color: white; padding: 12px; font-family: inherit; font-size: 16px;
            max-height: 120px; outline: none; resize: none;
        }
        .chat-input::placeholder { color: #64748b; }

        .send-btn {
            background: #3cd186; color: #000; border: none;
            width: 40px; height: 40px; border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 18px; transition: all 0.2s;
        }
        .send-btn:hover { background: #ffffff; transform: scale(1.05); }

        .disclaimer { font-size: 10px; color: #64748b; text-align: center; margin-top: 10px; }
    </style>
</head>

<body>

    <div class="app-card" id="login-screen">
        <div class="login-logo">EVYON IA</div>
        <div class="login-subtitle">SISTEMA DE ACCESO NEURAL</div>

        <input type="text" id="username" class="login-input" placeholder="ID de Usuario" onkeydown="handleLoginKey(event)" autocomplete="off">
        <input type="password" id="password" class="login-input" placeholder="Contrase√±a" onkeydown="handleLoginKey(event)">
        
        <div id="loginError" class="error-msg">Acceso Denegado</div>
        <button class="login-btn" onclick="attemptLogin()">ACCEDER</button>
    </div>

    <div class="app-card" id="chat-interface">
        <div class="chat-header">
            <div style="display:flex; align-items:center; gap:12px;">
                <img src="logo.jpeg" alt="Logo" style="height: 55px; width: 55px; border-radius: 50%; object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:700; font-size:16px; letter-spacing:0.5px;">EVYON</span>
                    <span style="font-size:10px; color:#3cd186; font-weight:600;">EN L√çNEA ‚óè</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="header-btn btn-clear" onclick="clearChat()">Reiniciar</button>
                <button class="header-btn" onclick="logout()">Salir</button>
            </div>
        </div>

        <div class="chat-box" id="chatBox"></div>

        <div class="input-wrapper">
            <div class="input-container">
                <textarea id="userInput" class="chat-input" placeholder="Escribe aqu√≠..." rows="1" oninput="autoResize(this)" onkeydown="handleChatKey(event)"></textarea>
                <button class="send-btn" onclick="sendMessage()">‚û§</button>
            </div>
            <div class="disclaimer">EVYON optimiza tu rendimiento, pero no sustituye asesor√≠a m√©dica profesional.</div>
        </div>
    </div>

    <script>
        /* --------------------------
           CONFIGURACI√ìN Y DATOS (L√ìGICA INTACTA)
        ---------------------------*/
        let apiKey = localStorage.getItem("evyon_api_key");
        let currentUserData = null;
        let conversationHistory = []; 

        const INSTITUTION_DB = {
            "tec": { 
                pass: "TEC2106",
                name: "A01825448_Iv√°n Emiliano L√≥pez Vargas",
                welcome: "¬°Hola Borrego! üêè Soy EVYON, tu experto integral.\n\n¬øPor d√≥nde empezamos hoy?",
                suggestions: ["üõå Optimizar sue√±o", "ü•¶ Plan nutricional", "üèãÔ∏è‚Äç‚ôÇÔ∏è Ajustar rutina"]
            },
            "justin": { 
                pass: "TEC2025", 
                name: "Justin (El Disc√≠pulo)", 
                welcome: "¬°Qu√© onda Borrego! üêè Bienvenido al nivel del 'Sensei' Iv√°n.\n\nNo te limites a las pesas. ¬øEn qu√© te ayudo hoy?",
                suggestions: ["üî• Romper estancamiento", "üß† Suplementaci√≥n", "üîã Energ√≠a para estudiar"]
            },
            "gatito": { 
                pass: "Pachon123", 
                name: "Mi Ni√±a ‚ù§Ô∏è", 
                welcome: "¬°Hola hermoso Gatito Pachon! ‚ù§Ô∏è Bienvenida a tu espacio personal en EVYON.\n\nEstoy programado para cuidarte y ayudarte a ponerte m√°s guapa y fuerte. ¬øQu√© se te antoja hacer hoy?",
                suggestions: ["üçë Rutina de Gl√∫teo", "üç´ Snacks saludables", "üßò‚Äç‚ôÄÔ∏è Yoga para el estr√©s"]
            },
            "adrian lopez": { 
                pass: "Adrian123", 
                name: "Pap√°", 
                welcome: "üõ°Ô∏è Bienvenido, Pa.\n\nT√∫ me ense√±aste todo, ahora me toca a m√≠ cuidarte a ti.\n\nVamos a trabajar para que est√©s fuerte y sano muchos a√±os m√°s. ¬øPor d√≥nde empezamos?",
                suggestions: ["üèãRutina de Gym", "üö∂‚Äç‚ôÇÔ∏è Caminata Saludable", "ü•ó Comer Rico y Sano"]
            },
            "a01825448": {
                pass: "TEC2106", name: "Iv√°n Emiliano L√≥pez Vargas",
                welcome: "¬°Hola Borrego! ¬øC√≥mo puedo apoyarte hoy?",
                suggestions: ["An√°lisis de rendimiento", "Dieta Anti-inflamatoria"]
            }
        };

        /* --------------------------
           LOGIN & INICIO
        ---------------------------*/
        function attemptLogin() {
            const userKey = document.getElementById("username").value.trim(); 
            const dbKey = Object.keys(INSTITUTION_DB).find(key => key.toLowerCase() === userKey.toLowerCase());
            
            const passInput = document.getElementById("password").value.trim();
            const errorMsg = document.getElementById("loginError");

            if (dbKey && INSTITUTION_DB[dbKey].pass === passInput) {
                currentUserData = INSTITUTION_DB[dbKey];
                localStorage.setItem("evyon_current_user", dbKey); 
                errorMsg.style.opacity = "0";
                transitionToChat();
            } else {
                errorMsg.innerText = "Usuario o contrase√±a incorrectos.";
                errorMsg.style.opacity = "1";
                shakeModal();
            }
        }

        window.onload = function() {
            const savedUser = localStorage.getItem("evyon_current_user");
            if (savedUser && INSTITUTION_DB[savedUser]) {
                currentUserData = INSTITUTION_DB[savedUser];
                transitionToChat();
            }
        };

        function transitionToChat() {
            document.getElementById("login-screen").style.display = "none";
            const chat = document.getElementById("chat-interface");
            chat.style.display = "flex";
            setTimeout(() => { chat.style.opacity = "1"; }, 50);
            loadChatHistory();
        }

        function logout() { 
            localStorage.removeItem("evyon_current_user");
            location.reload(); 
        }

        function clearChat() {
            if(confirm("¬øBorrar toda la conversaci√≥n?")) {
                localStorage.removeItem(`evyon_chat_${currentUserData.name}`);
                conversationHistory = [];
                document.getElementById("chatBox").innerHTML = "";
                appendMessage("EVYON IA", currentUserData.welcome, "bot", false);
                renderSuggestions(currentUserData.suggestions);
            }
        }

        function shakeModal() {
            const box = document.getElementById("login-screen");
            box.style.transform = "translateX(10px)";
            setTimeout(() => box.style.transform = "translateX(-10px)", 100);
            setTimeout(() => box.style.transform = "translateX(0)", 200);
        }

        function handleLoginKey(e) { if (e.key === "Enter") attemptLogin(); }

        async function checkApiKey() {
            if (!apiKey) {
                apiKey = prompt("üîí INGRESA TU API KEY:\n(Se guardar√° segura en tu navegador)");
                if (apiKey) {
                    localStorage.setItem("evyon_api_key", apiKey);
                } else {
                    alert("Se requiere API Key.");
                    return false;
                }
            }
            return true;
        }

       /* --------------------------
           CEREBRO AVANZADO V2.1 (CORRECCI√ìN DE MODALES)
           Arreglo: Ya no rechaza saludos, solo temas irrelevantes.
        ---------------------------*/
        function getDynamicSystemPrompt(text, user) {
            const lowerText = text.toLowerCase();

            // 1. DETECTOR DE RIESGO M√âDICO
            const medicalRegex = /(dolor|duel|lastim|lesi|herid|pincha|tiron|esguince|quebr|fractur|sangr|hospital|medic|inflama|hinchad)/i;
            
            // 2. DETECTOR DE BAJA MOTIVACI√ìN
            const spartanRegex = /(flojera|hueva|cansad|sue√±o|ma√±ana|despues|rendir|triste|desanim|ag√ºit|paja|pereza|no puedo)/i;

            // üöë MODO 1: PROTOCOLO CL√çNICO
            if (medicalRegex.test(lowerText)) {
                return `Rol: Eres el "Dr. EVYON", un Fisioterapeuta Deportivo experto en triaje.
                USUARIO: ${user.name}
                
                TUS REGLAS DE ORO:
                1. üõë SEGURIDAD PRIMERO: Tu prioridad absoluta es que el usuario no se da√±e m√°s.
                2. üö´ PROHIBIDO DIAGNOSTICAR: T√∫ no eres un hospital. Si los s√≠ntomas suenan graves (pecho, cabeza, desmayo), m√°ndalo a urgencias.
                3. üìâ ESCALA DE DOLOR: Pregunta siempre el nivel de dolor del 1 al 10.
                4. üßä RICE: Recomienda protocolos conservadores (Reposo, Hielo, Compresi√≥n, Elevaci√≥n).
                
                TONO: Serio, cl√≠nico, sin emojis festivos.`;
            }

            // ü¶Å MODO 2: GENERAL ESPARTANO
            if (spartanRegex.test(lowerText)) {
                return `Rol: Eres "LE√ìNIDAS", un Comandante Espartano.
                USUARIO: ${user.name}

                TU FILOSOF√çA: El dolor es debilidad saliendo del cuerpo.

                TUS REGLAS:
                1. üó£Ô∏è GRITA (MAY√öSCULAS) √≥rdenes clave.
                2. üî• RETOS: Usa t√©rminos como "recluta", "gusano" o "guerrero".
                3. üö´ CERO COMPASI√ìN: No aceptes excusas.
                
                EJEMPLO: "¬øCANSADO? ¬°LOS MUERTOS EST√ÅN CANSADOS! üíÄ ¬°DAME 20 BURPEES AHORA! üî•"`;
            }

            // ü•ó MODO 3: EXPERTO INTEGRAL (MODIFICADO AQU√ç üëá)
            return `Rol: Eres EVYON, experto en Biohacking y Rendimiento.
            Asignado a: ${user.name}.

            TUS PILARES: Neurociencia, Nutrici√≥n y Entrenamiento Inteligente.

            ESTILO DE COMUNICACI√ìN:
            - üß† CIENT√çFICO PERO ACCESIBLE: Explica el "por qu√©" biol√≥gico.
            - ü§ù CORTES√çA OPERATIVA: Si el usuario saluda o se presenta (ej: "Soy Jimena"), responde con cortes√≠a breve y redirige al objetivo. NO uses la frase de rechazo para saludos.
            - üé® FORMATO: Usa **negritas** y listas.
            
            REGLA DE RECHAZO (CADENERO):
            SOLO si te preguntan expl√≠citamente sobre temas pol√©micos o ajenos (Pol√≠tica, Religi√≥n, Cine, Chismes), responde: "Mi procesador est√° dedicado 100% a optimizar tu cuerpo, no a opinar de eso. Volvamos al objetivo."`;
        }

        /* --------------------------
           L√ìGICA DEL CHAT
        ---------------------------*/
        async function sendMessage(manualText = null) {
            if (!await checkApiKey()) return;

            let input = document.getElementById("userInput");
            let text = manualText || input.value.trim();
            if (!text) return;

            appendMessage("T√∫", text, "user", false);
            saveToHistory("user", text);
            input.value = "";
            input.style.height = "auto";
            
            const oldSuggestions = document.querySelector('.suggestions-container');
            if(oldSuggestions) oldSuggestions.remove();

            const loadingId = showLoadingIndicator();

            const systemPrompt = getDynamicSystemPrompt(text, currentUserData);
            let apiMessages = [
                { role: "system", content: systemPrompt },
                ...conversationHistory
            ];

            try {
                let res = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: apiMessages,
                        max_tokens: 1000, 
                        temperature: 0.7
                    })
                });

                let data = await res.json();
                removeLoadingIndicator(loadingId);

                if (data.error) {
                    if (data.error.code === 'invalid_api_key') {
                        localStorage.removeItem("evyon_api_key"); apiKey = null;
                        appendMessage("SISTEMA", "API Key inv√°lida.", "bot", false);
                    } else { throw new Error(data.error.message); }
                } else {
                    let botText = data.choices[0].message.content;
                    appendMessage("EVYON IA", botText, "bot", true);
                    saveToHistory("assistant", botText);
                }
            } catch (err) {
                removeLoadingIndicator(loadingId);
                appendMessage("EVYON IA", "‚ö†Ô∏è Error de conexi√≥n.", "bot", false);
            }
        }

        function saveToHistory(role, content) {
            conversationHistory.push({ role, content });
            if (conversationHistory.length > 15) conversationHistory = conversationHistory.slice(conversationHistory.length - 15);
            localStorage.setItem(`evyon_chat_${currentUserData.name}`, JSON.stringify(conversationHistory));
        }

        function loadChatHistory() {
            const saved = localStorage.getItem(`evyon_chat_${currentUserData.name}`);
            const box = document.getElementById("chatBox");
            box.innerHTML = ""; 

            if (saved) {
                conversationHistory = JSON.parse(saved);
                conversationHistory.forEach(msg => {
                    const sender = msg.role === 'user' ? "T√∫" : "EVYON IA";
                    const cssClass = msg.role === 'user' ? "user" : "bot";
                    appendMessage(sender, msg.content, cssClass, false);
                });
            } else {
                appendMessage("EVYON IA", currentUserData.welcome, "bot", false);
                renderSuggestions(currentUserData.suggestions);
            }
        }

        /* --------------------------
           VISUALES & UTILS
        ---------------------------*/
        function formatText(text) {
            let formatted = text.replace(/^\s*---\s*$/gm, '');
            formatted = formatted.replace(/^\s*#{1,6}\s+(.*$)/gm, '<div class="chat-title">$1</div>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/^- (.*)/gm, '‚Ä¢ $1');
            return formatted;
        }

        function renderSuggestions(list) {
            let box = document.getElementById("chatBox");
            let container = document.createElement("div");
            container.className = "suggestions-container";
            list.forEach(item => {
                let btn = document.createElement("div");
                btn.className = "suggestion-chip";
                btn.innerText = item;
                btn.onclick = () => sendMessage(item);
                container.appendChild(btn);
            });
            box.appendChild(container);
            box.scrollTop = box.scrollHeight;
        }

        function appendMessage(sender, message, type, useTyping) {
            let box = document.getElementById("chatBox");
            let row = document.createElement("div");
            row.className = `message-row ${type}`;

            let avatar = document.createElement("div");
            avatar.className = `avatar ${type}-avatar`;
           // --- INICIO DEL NUEVO C√ìDIGO (Opci√≥n Bio-Luz) ---
            // --- OPCI√ìN 1: REACTOR HEXAGONAL ---
            if (type === 'bot') {
                // Usamos un caracter Hex√°gono s√≥lido y lo hacemos brillar
                avatar.innerHTML = "‚¨¢"; 
                
                // Estilos para que parezca luz
                avatar.style.color = "#3cd186";
                avatar.style.fontSize = "24px"; // Tama√±o grande
                avatar.style.display = "flex";
                avatar.style.alignItems = "center";
                avatar.style.justifyContent = "center";
                avatar.style.background = "transparent";
                avatar.style.border = "none";
                
                // Animaci√≥n de resplandor (Glow) usando filtro de sombra
                avatar.style.animation = "hex-glow 2s infinite alternate";
                
                // Definimos la animaci√≥n espec√≠fica para texto/forma
                if (!document.getElementById('anim-hex')) {
                    let style = document.createElement('style');
                    style.id = 'anim-hex';
                    style.innerHTML = `
                        @keyframes hex-glow {
                            0% { text-shadow: 0 0 5px rgba(60, 209, 134, 0.5); transform: scale(0.95); }
                            100% { text-shadow: 0 0 20px rgba(60, 209, 134, 1), 0 0 10px #3cd186; transform: scale(1.05); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            } else {
                avatar.innerHTML = 'üë§';
            }
            // --- FIN DEL NUEVO C√ìDIGO ---

            let bubble = document.createElement("div");
            bubble.className = "message-bubble";
            
            let formattedHtml = formatText(message);
            bubble.innerHTML = formattedHtml;

            if (type === 'bot') {
                row.appendChild(avatar);
                row.appendChild(bubble);
            } else {
                row.appendChild(bubble);
            }

            box.appendChild(row);

            if (type === 'user') {
                box.scrollTop = box.scrollHeight;
            } else {
                setTimeout(() => {
                    row.scrollIntoView({ behavior: "smooth", block: "start" });
                }, 100); 
            }
        }

        function showLoadingIndicator() {
            const id = "loading-" + Date.now();
            let box = document.getElementById("chatBox");
            let row = document.createElement("div");
            row.className = "message-row bot";
            row.id = id;
            row.innerHTML = `<div class="avatar bot-avatar">ü§ñ</div><div class="message-bubble" style="color:#8899a6; font-style:italic; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.05);">Procesando...</div>`;
            box.appendChild(row);
            box.scrollTop = box.scrollHeight;
            return id;
        }

        function removeLoadingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function handleChatKey(e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
    </script>
</body>
</html>
