<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVYON IA - Acceso Institucional</title>

    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef1f5; /* Un tono gris m√°s moderno */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        /* --- CONTENEDORES (RESPONSIVE) --- */
        .app-card {
            width: 90%;          /* Ocupa el 90% en celular */
            max-width: 400px;    /* Pero no pasa de 400px en PC */
            background-color: #3D3D3D;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0px 15px 35px rgba(0, 0, 0, 0.4);
            position: relative;
            transition: opacity 0.5s ease;
            display: flex;
            flex-direction: column;
            max-height: 90vh; /* Para que no se salga de pantallas chicas */
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            text-align: center;
            color: white;
            padding: 30px 10px;
        }

        .login-logo {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 5px;
            color: #3cd186;
            letter-spacing: 1px;
        }

        .login-subtitle {
            font-size: 13px; 
            color: #aaa; 
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .login-input {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: 1px solid #555;
            border-radius: 8px;
            background-color: #2b2b2b;
            color: white;
            outline: none;
            box-sizing: border-box; /* Para que el padding no rompa el ancho */
            transition: all 0.3s;
        }

        .login-input:focus {
            border-color: #3cd186;
            background-color: #333;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            margin-top: 20px;
            background: linear-gradient(90deg, #3cd186, #2eb06d);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(60, 209, 134, 0.3);
        }

        .error-msg {
            color: #ff6b6b;
            font-size: 13px;
            margin-top: 15px;
            min-height: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* --- CHAT --- */
        #chat-interface {
            display: none;
            opacity: 0;
            height: 600px; /* Altura fija base */
        }

        .chat-header {
            background-color: #2b2b2b;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .logout-btn {
            font-size: 12px;
            color: #888;
            cursor: pointer;
            background: none;
            border: none;
            text-decoration: underline;
        }
        .logout-btn:hover { color: #ff6b6b; }

        .chat-box {
            background-color: #ffffff;
            flex: 1; /* Ocupa el espacio disponible */
            overflow-y: auto;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scroll-behavior: smooth;
        }

        /* Scrollbar bonito */
        .chat-box::-webkit-scrollbar { width: 6px; }
        .chat-box::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 4px; }

        .user-message, .bot-message {
            padding: 12px 16px;
            border-radius: 14px;
            max-width: 85%;
            font-size: 15px;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
        }

        .user-message {
            background-color: #3cd186;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
            box-shadow: 0 2px 5px rgba(60, 209, 134, 0.2);
        }

        .bot-message {
            background-color: #f3f4f6;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid #eee;
        }

        /* Estilos internos del bot */
        .bot-message strong { color: #1a5e3a; font-weight: 700; }
        .chat-title {
            font-size: 1.1em;
            font-weight: 800;
            color: #1b5e20; 
            margin-top: 15px;
            margin-bottom: 5px;
            display: block;
        }

        /* --- SUGGESTION CHIPS (Botones R√°pidos) --- */
        .suggestions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .suggestion-chip {
            background-color: white;
            border: 1px solid #3cd186;
            color: #3cd186;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        .suggestion-chip:hover {
            background-color: #3cd186;
            color: white;
        }

        /* --- INPUT --- */
        .input-container {
            display: flex;
            margin-top: 15px;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            outline: none;
            resize: none;
            height: 50px;
            font-family: inherit;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .send-btn {
            background-color: #3cd186;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        .send-btn:hover { background-color: #2eb06d; }

    </style>
</head>

<body>

    <div class="app-card" id="login-screen">
        <div class="login-logo">EVYON IA üîí</div>
        <div class="login-subtitle">Acceso Institucional Seguro</div>

        <input type="text" id="username" class="login-input" placeholder="Usuario / ID" onkeydown="handleLoginKey(event)">
        <input type="password" id="password" class="login-input" placeholder="Contrase√±a" onkeydown="handleLoginKey(event)">
        
        <div id="loginError" class="error-msg">Credenciales incorrectas</div>
        <button class="login-btn" onclick="attemptLogin()">INGRESAR</button>
    </div>

    <div class="app-card" id="chat-interface">
        <div class="chat-header">
            <span style="display:flex; align-items:center; gap:8px;">ü§ñ EVYON IA</span>
            <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>

        <div class="chat-box" id="chatBox"></div>

        <div class="input-container">
            <textarea id="userInput" class="chat-input" placeholder="Escribe aqu√≠..." onkeydown="handleChatKey(event)"></textarea>
            <button class="send-btn" onclick="sendMessage()">Enviar</button>
        </div>
    </div>

    <script>
        /* --------------------------
           CONFIGURACI√ìN Y DATOS
        ---------------------------*/
        let apiKey = localStorage.getItem("evyon_api_key");
        let currentUserData = null;
        // üß† MEMORIA: Aqu√≠ guardaremos la conversaci√≥n para que EVYON no olvide
        let conversationHistory = []; 

        const INSTITUTION_DB = {
            "tec": { 
                pass: "TEC2106",
                name: "A01825448_Iv√°n Emiliano L√≥pez Vargas",
                welcome: "¬°Hola Borrego! üêè Soy EVYON, tu experto integral.\n\n¬øPor d√≥nde empezamos hoy?",
                suggestions: ["üõå Optimizar sue√±o", "ü•¶ Plan nutricional", "üèãÔ∏è‚Äç‚ôÇÔ∏è Ajustar rutina"]
            },
            "justin": { 
                pass: "TEC2025", 
                name: "Justin (El Disc√≠pulo)", 
                welcome: "¬°Qu√© onda Borrego! üêè Bienvenido al nivel del 'Sensei' Iv√°n.\n\nNo te limites a las pesas. ¬øEn qu√© te ayudo hoy?",
                suggestions: ["üî• Romper estancamiento", "üß† Suplementaci√≥n", "üîã Energ√≠a para estudiar"]
            },
            "oxigeno": {
                pass: "oxi123",
                name: "Gimnasio Ox√≠geno",
                welcome: "¬°Hola equipo Ox√≠geno! üí™ Listos para optimizar.",
                suggestions: ["Rutina Hipertrofia", "D√©ficit Cal√≥rico"]
            },
             "A01825448": {
                pass: "TEC2106",
                name: "Iv√°n Emiliano L√≥pez Vargas",
                welcome: "¬°Hola Borrego! ¬øC√≥mo puedo apoyarte hoy?",
                suggestions: ["An√°lisis de rendimiento", "Dieta Anti-inflamatoria"]
            }
        };

        /* --------------------------
           LOGIN & INICIO
        ---------------------------*/
        function attemptLogin() {
            const userKey = document.getElementById("username").value.trim().toLowerCase();
            const passInput = document.getElementById("password").value.trim();
            const errorMsg = document.getElementById("loginError");

            if (INSTITUTION_DB[userKey] && INSTITUTION_DB[userKey].pass === passInput) {
                currentUserData = INSTITUTION_DB[userKey];
                errorMsg.style.opacity = "0";
                transitionToChat();
            } else {
                errorMsg.innerText = "Usuario o contrase√±a incorrectos.";
                errorMsg.style.opacity = "1";
                shakeModal();
            }
        }

        function transitionToChat() {
            document.getElementById("login-screen").style.display = "none";
            const chat = document.getElementById("chat-interface");
            chat.style.display = "flex"; // Flex para que ocupe altura correcta
            setTimeout(() => { chat.style.opacity = "1"; }, 50);

            if(conversationHistory.length === 0){
                 // Mostrar mensaje de bienvenida + Botones
                 appendMessage("EVYON IA", currentUserData.welcome, "bot-message", false);
                 renderSuggestions(currentUserData.suggestions);
            }
            setTimeout(() => document.getElementById("userInput").focus(), 300);
        }

        function logout() { location.reload(); }

        function shakeModal() {
            const box = document.getElementById("login-screen");
            box.style.transform = "translateX(10px)";
            setTimeout(() => box.style.transform = "translateX(-10px)", 100);
            setTimeout(() => box.style.transform = "translateX(0)", 200);
        }

        function handleLoginKey(e) { if (e.key === "Enter") attemptLogin(); }

        async function checkApiKey() {
            if (!apiKey) {
                apiKey = prompt("üîí INGRESA TU API KEY:\n(Se guardar√° segura en tu navegador)");
                if (apiKey) {
                    localStorage.setItem("evyon_api_key", apiKey);
                } else {
                    alert("Se requiere API Key.");
                    return false;
                }
            }
            return true;
        }

        /* --------------------------
           CEREBRO 7.0 (Prompt del Sistema)
        ---------------------------*/
        function getDynamicSystemPrompt(text, user) {
            const lowerText = text.toLowerCase();

            // üöë MODO 1: M√âDICO
            if (lowerText.includes("dolor") || lowerText.includes("duele") || lowerText.includes("lesi√≥n") || lowerText.includes("enfermo")) {
                return `Act√∫a como Fisioterapeuta Deportivo Cauteloso para ${user.name}.
                PRIORIDAD: SEGURIDAD.
                - Si hay dolor, NO recomiendes ejercicios que lo empeoren.
                - Sugiere descanso/m√©dico.
                - Tono serio y emp√°tico.`;
            }

            // ü¶Å MODO 2: COACH
            if (lowerText.includes("flojera") || lowerText.includes("no quiero") || lowerText.includes("rendir") || lowerText.includes("cansado")) {
                return `Act√∫a como Coach Espartano para ${user.name}.
                OBJETIVO: LEVANTAR EL √ÅNIMO.
                - Tono en√©rgico, may√∫sculas, emojis fuego (üî•).
                - S√© breve e inspirador.`;
            }

            // ü•ó MODO 3: EXPERTO INTEGRAL (DEFAULT)
            return `Eres EVYON, Experto en Rendimiento Humano (Nutrici√≥n, Entreno, Sue√±o, Psicolog√≠a) para: ${user.name}.
            
            REGLAS 7.0:
            1. **NO ROBOT**: No saludes con "Hola ${user.name}" siempre. S√© natural.
            2. **PERFILAMIENTO**: Si te piden dieta/rutina y no sabes sus datos, PREGUNTA PRIMERO (peso, meta, lesiones).
            3. **ESPEJO**: Si el usuario es t√©cnico, s√© cient√≠fico. Si es casual, s√© c√°lido.
            4. **RECHAZO AMABLE**: Si preguntan de Autos/Tecnolog√≠a, di: "No soy experto en eso, pero si tu cuerpo fuera un auto... ¬øHablamos de salud?".
            5. **CIENCIA**: Basa todo en ACSM/OMS sin citar aburrido.
            6. **FORMATO**: Usa listas, negritas y emojis.
            
            Responde siempre en espa√±ol.`;
        }

        /* --------------------------
           L√ìGICA DEL CHAT (Con Memoria)
        ---------------------------*/
        async function sendMessage(manualText = null) {
            if (!await checkApiKey()) return;

            let input = document.getElementById("userInput");
            let text = manualText || input.value.trim();
            if (!text) return;

            // 1. Mostrar mensaje usuario
            appendMessage("T√∫", text, "user-message", false);
            input.value = "";
            
            // Eliminar sugerencias viejas si existen
            const oldSuggestions = document.querySelector('.suggestions-container');
            if(oldSuggestions) oldSuggestions.remove();

            const loadingId = showLoadingIndicator();

            // 2. Preparar el Cerebro y la Memoria
            const systemPrompt = getDynamicSystemPrompt(text, currentUserData);
            
            // Construir el historial para enviar a OpenAI
            // Siempre ponemos el System Prompt actualizado al principio
            let apiMessages = [
                { role: "system", content: systemPrompt },
                ...conversationHistory, // Historial previo
                { role: "user", content: text } // Mensaje actual
            ];

            try {
                let res = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: apiMessages,
                        max_tokens: 1000, 
                        temperature: 0.7
                    })
                });

                let data = await res.json();
                removeLoadingIndicator(loadingId);

                if (data.error) {
                    handleApiError(data.error);
                } else {
                    let botText = data.choices[0].message.content;
                    
                    // 3. Guardar en memoria (Usuario + Bot)
                    conversationHistory.push({ role: "user", content: text });
                    conversationHistory.push({ role: "assistant", content: botText });

                    // Limitar memoria a √∫ltimos 10 mensajes para ahorrar tokens
                    if (conversationHistory.length > 10) {
                        conversationHistory = conversationHistory.slice(conversationHistory.length - 10);
                    }

                    // 4. Mostrar respuesta con efecto Typing
                    appendMessage("EVYON IA", botText, "bot-message", true);
                }
            } catch (err) {
                removeLoadingIndicator(loadingId);
                appendMessage("EVYON IA", "‚ö†Ô∏è Error de conexi√≥n.", "bot-message", false);
            }
        }

        function handleApiError(error) {
            if (error.code === 'invalid_api_key' || error.code === 'invalid_api_key_header') {
                localStorage.removeItem("evyon_api_key");
                apiKey = null;
                appendMessage("SISTEMA", "‚ùå API Key inv√°lida.", "bot-message", false);
            } else { 
                appendMessage("SISTEMA", "Error: " + error.message, "bot-message", false);
            }
        }

        /* --------------------------
           VISUALES & UTILS
        ---------------------------*/
        function formatText(text) {
            let formatted = text.replace(/^\s*---\s*$/gm, '');
            formatted = formatted.replace(/^\s*#{1,6}\s+(.*$)/gm, '<div class="chat-title">$1</div>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/^- (.*)/gm, '‚Ä¢ $1');
            return formatted;
        }

        // Funci√≥n para renderizar botones de sugerencia
        function renderSuggestions(list) {
            let box = document.getElementById("chatBox");
            let container = document.createElement("div");
            container.className = "suggestions-container";
            
            list.forEach(item => {
                let btn = document.createElement("div");
                btn.className = "suggestion-chip";
                btn.innerText = item;
                btn.onclick = () => sendMessage(item); // Al hacer click, env√≠a el mensaje
                container.appendChild(btn);
            });
            
            box.appendChild(container);
            box.scrollTop = box.scrollHeight;
        }

        function appendMessage(sender, message, className, useTypingEffect) {
            let box = document.getElementById("chatBox");
            let div = document.createElement("div");
            div.classList.add(className);
            
            // Preparar HTML base
            let headerHtml = `<strong>${sender}:</strong> `;
            let contentHtml = formatText(message);

            if (className === 'bot-message' && useTypingEffect) {
                // Efecto Typing
                div.innerHTML = headerHtml; // Poner el nombre primero
                let contentSpan = document.createElement('span');
                div.appendChild(contentSpan);
                box.appendChild(div);
                
                // Simulaci√≥n de escritura r√°pida
                // Nota: El HTML formateado es dif√≠cil de "tipear" caracter por caracter sin romper tags.
                // Para simplificar y mantener formato rico, mostramos bloque por bloque o fade in r√°pido.
                // Aqu√≠ usaremos FadeIn r√°pido que ya tenemos en CSS, pero retrasado.
                contentSpan.innerHTML = contentHtml;
                
            } else {
                div.innerHTML = headerHtml + contentHtml;
                box.appendChild(div);
            }

            box.scrollTop = box.scrollHeight;
        }

        function showLoadingIndicator() {
            const id = "loading-" + Date.now();
            let box = document.getElementById("chatBox");
            let div = document.createElement("div");
            div.id = id;
            div.classList.add("bot-message");
            div.style.color = "#888";
            div.style.fontStyle = "italic";
            div.innerText = "Escribiendo...";
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            return id;
        }

        function removeLoadingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function handleChatKey(e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
    </script>
</body>
</html>
